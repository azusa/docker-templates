
# Couchbase Docker container

This is a collection of images and scripts to help you run Couchbase 2.2 in Docker containers.
This image is great to provision ephemeral Couchbase topologies for testing and development purpose.
This project was partly inspired by [dustin/couchbase](https://gist.github.com/dustin/6605182).

## Prerequisites

You need to override memlock and nofile limits to make Couchbase run correctly. 
Add the following lines at the end of the `/etc/init/docker.conf` file:

	limit memlock unlimited unlimited
	limit nofile 262144

Finally, restart the Docker daemon: `/etc/init.d/docker restart`.

## Single Couchbase node

1. Create the Couchbase container

		docker run -d -name cb ncolomer/couchbase

	You can also add the options generated by the `$(./scripts/ports raz)` script to bind Couchbase client ports (8091, 8092, 11210, 11211) to host.

		docker run -d $(./scripts/ports raz) -name cb ncolomer/couchbase

2. Check the Couchbase instance is up&running

	Using Telnet (Memcached text protocol)

		$ telnet localhost
		# Check health
		stats
		# Set and get a key
		set test_key 0 0 1
		get test_key
		# Disconnect
		quit

	Using `couchbase-cli`

		docker run -d -name cb ncolomer/couchbase couchbase-cli server-info -c $(./scripts/ipof cb)

	Using HTTP

		curl -u Administrator:couchbase http://$(./scripts/ipof cb):8091/pools/default/buckets/default/nodes

	Using admin interface: open the output of `echo http://$(./scripts/ipof cb):8091` in your favorite browser.

## 3-node cluster

Create the containers as following:

	docker run -d -name cb1 ncolomer/couchbase
	docker run -d -name cb2 ncolomer/couchbase couchbase-start $(./scripts/ipof cb1)
	docker run -d -name cb3 ncolomer/couchbase couchbase-start $(./scripts/ipof cb1)

The nodes `cb2` and `cb3` will automatically join the cluster via `cb1`.

## Two 2-node cluster (XDCR base)

Create the containers as following:

	docker run -d $(./scripts/ports raz) -name cb11 ncolomer/couchbase
	docker run -d -name cb12 ncolomer/couchbase couchbase-start $(./scripts/ipof cb11)
	docker run -d $(./scripts/ports) -name cb21 ncolomer/couchbase
	docker run -d -name cb22 ncolomer/couchbase couchbase-start $(./scripts/ipof cb21)

Then open the URL `http://$CB11_URL:8091` (replace `$CB11_URL` by the output of `./scripts/ipof cb11`) in your favorite browser and create the XDCR as described in the [Set Source and Destination Clusters](http://docs.couchbase.com/couchbase-manual-2.2/#set-source-and-destination-clusters) documentation page.
You will have to provide at lease one IP of a node in the second cluster, the IP `./scripts/ipof cb21` is a good choice.

## Routing magic

If you host Docker on a Virtual Machine (a Vagrant managed VM for instance), you can make docker containers reachable from your VM's host by routing request to the docker bridge:

	sudo route add -net $DOCKER_BRIDGE_GATEWAY $VM_IP

Example:

	sudo route add -net 172.17.0.0 192.168.10.10

